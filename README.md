## Генерация и деперсонификация покупателей

## Приложение `app.ts`

приложение эмулирует работу магазина.

-   Оно вечно генерирует покупателей и вставляет их в БД.
-   Для генерации используется библиотека \***\*[Faker](https://www.npmjs.com/package/@faker-js/faker)\*\***.
-   Покупатели создаются случайными пачками по 1 - 10 покупателей каждые 200 миллисекунд, и так же пачками вставляются в коллекцию `customers`.

## Приложение `sync.ts`

Это приложение копирует и анонимизирует покупателей.

-   Приложение “слушает” появление и **изменение** документов в коллекции `customers` и анонимизирует их:
    -   Заменяются содержимое полей `firstName`, `lastName`, часть до `@` в поле `email`, `address.line1`, `address.line2` и `postcode`.
    -   Значения заменяются на 8-значную случайную, но детерминированную последовательность символов `[a-zA-Z\d]`.
-   После анонимизации записи вставляются в `customers_anonymised` следующим образом:
    -   Приложение накапливает пачки по 1,000 документов.
    -   Если не удалось накопить пачку за 1 секунду, то вставляется то что есть.
-   Приложение может быть перезапущено. В случае перезапуска оно должно продолжить с того места где остановилось, не пропустив те изменения, которые случились пока приложение было оффлайн.
-   Приложение можно запустить в двух режимах:
    -   Реалтайм синхронизация. Это дефолтное поведение, которое описано выше. Оно работает, если `sync.ts` запущен без аргументов.
    -   Полная синхронизация. Включается, при наличии флага `--full-reindex`. В этом режиме приложение вместо того чтобы слушать изменения, должно запуститься и перелить все данные пачками по 1000 документов, анонимизировов их. В случае успеха, приложение завершает свою работу с кодом `0`.
-   Оба режима могут работать параллельно. То есть одновременно можно запустить два инстанса — один в реалтайме, второй в режиме полной синхронизации.

## Установка

```bash
$ git clone git@github.com:OLEIVO/fundraiseup-test.git
$ yarn install
```

## Запуск

```bash
# Запуск скрипта /scripts/app.ts, который генерирурует покупателей и записывает их в БД
$ yarn run serve

# Запуск синхронизации покупателей. Происходит подписка на изменения в коллекции consumers и добавление деперсонифицированных копий в коллекцию consumers_anonymised
$ yarn run sync

# Запуск полной синхронизации покупателей. Происходит получение consumers из БД посредством пагинации и их деперсонификация с последующим сохранением в коллекцию consumers_anonymised
$ yarn run sync:full-reindex
```
